---
import { SITE } from "@/config";
import "@/styles/global.css";

import "@fontsource/ibm-plex-sans-thai/400.css";
import "@fontsource/ibm-plex-sans-thai/500.css";
import "@fontsource/ibm-plex-sans-thai/600.css";
import "@fontsource/ibm-plex-sans-thai/700.css";
import { ClientRouter } from "astro:transitions";

export interface Props {
  title?: string;
  author?: string;
  profile?: string;
  description?: string;
  ogImage?: string;
  canonicalURL?: string;
  pubDatetime?: Date;
  modDatetime?: Date | null;
  scrollSmooth?: boolean;
  robots?: string;
  prevPost?: { slug: string; title?: string } | null;
  nextPost?: { slug: string; title?: string } | null;
}

const {
  title = SITE.title,
  author = SITE.author,
  profile = SITE.profile,
  description = SITE.desc,
  ogImage = SITE.ogImage,
  canonicalURL = new URL(Astro.url.pathname, Astro.url),
  pubDatetime,
  modDatetime,
  scrollSmooth = false,
  robots = "index, follow",
} = Astro.props;
const socialImageURL = new URL(ogImage ?? SITE.ogImage ?? "og.png", Astro.url);

// Ensure date values are Date objects before calling toISOString()
const pubDateObj = pubDatetime
  ? pubDatetime instanceof Date
    ? pubDatetime
    : new Date(pubDatetime)
  : undefined;
const modDateObj = modDatetime
  ? modDatetime instanceof Date
    ? modDatetime
    : new Date(modDatetime)
  : undefined;

const structuredData = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: `${title}`,
  image: `${socialImageURL}`,
  ...(pubDateObj && { datePublished: pubDateObj.toISOString() }),
  ...(modDateObj && { dateModified: modDateObj.toISOString() }),
  author: [
    {
      "@type": "Person",
      name: `${author}`,
      ...(profile && { url: profile }),
    },
  ],
};
---

<!doctype html>
<html lang="th" class={`${scrollSmooth && "scroll-smooth"}`}>
  <head>
    {/* Prev/Next links for articles (set by page via layout props) */}
    {
      Astro.props.prevPost && (
        <link rel="prev" href={`/blog/${Astro.props.prevPost.slug}`} />
      )
    }
    {
      Astro.props.nextPost && (
        <link rel="next" href={`/blog/${Astro.props.nextPost.slug}`} />
      )
    }
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <link rel="canonical" href={canonicalURL} />
    <meta name="generator" content={Astro.generator} />

    <!-- Google Tag Manager -->
    <script is:inline>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, "script", "dataLayer", "GTM-KP5D5J3");
    </script>
    <!-- End Google Tag Manager -->

    <!-- General Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />
    <meta name="author" content={author} />
    <meta
      name="keywords"
      content="front-end development, React, JavaScript, HTML, CSS, ภาษาไทย, บล็อก, tutorial, web development"
    />
    <meta name="robots" content={robots} />
    <link rel="sitemap" href="/sitemap-index.xml" />

    <!-- Open Graph / Facebook -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:image" content={socialImageURL} />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={SITE.title} />
    <meta property="og:locale" content="th_TH" />

    <!-- Article Published/Modified time -->
    {
      pubDateObj && (
        <meta
          property="article:published_time"
          content={pubDateObj.toISOString()}
        />
      )
    }
    {
      modDateObj && (
        <meta
          property="article:modified_time"
          content={modDateObj.toISOString()}
        />
      )
    }

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={socialImageURL} />

    <!-- Google JSON-LD Structured data -->
    <script
      is:inline
      type="application/ld+json"
      set:html={JSON.stringify(structuredData)}
    />

    <!-- Organization Schema -->
    <script
      is:inline
      type="application/ld+json"
      set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "Organization",
        name: SITE.title,
        url: SITE.website,
        logo: `${SITE.website}${SITE.ogImage}`,
        description: SITE.desc,
      })}
    />

    <!-- Font optimization: using @fontsource/ibm-plex-sans-thai in global css instead -->

    <!-- Theme Color: Defaults to light, overrides for dark mode system preference -->
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0f172a" />
    <meta name="color-scheme" content="light dark" />

    <!-- Cookie -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@v2.8.6/dist/cookieconsent.css"
    />

    <!-- Waline comment style -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/@waline/client@v3/dist/waline.css"
    />
    <!-- Waline comment end -->

    <!-- Web Vitals Monitoring -->
    <script is:inline>
      // Load web-vitals library
      (function () {
        const script = document.createElement("script");
        script.src = "https://unpkg.com/web-vitals@3/dist/web-vitals.iife.js";
        script.defer = true;
        script.onload = function () {
          // web-vitals is now available as window.webVitals
          function sendToAnalytics({ name, delta, value, id }) {
            // Push to dataLayer (GTM) if available
            if (
              window.dataLayer &&
              typeof window.dataLayer.push === "function"
            ) {
              window.dataLayer.push({
                event: "web-vitals",
                event_category: "Web Vitals",
                event_action: name,
                event_label: id,
                value: Math.round(name === "CLS" ? delta * 1000 : delta),
                metric_value: value,
              });
            }

            // Also log to console for debugging
            console.log(`${name}:`, {
              delta: Math.round(delta),
              value: Math.round(value),
              id,
            });
          }
          // Track Core Web Vitals
          if (window.webVitals) {
            window.webVitals.getCLS(sendToAnalytics);
            window.webVitals.getFID(sendToAnalytics);
            window.webVitals.getFCP(sendToAnalytics);
            window.webVitals.getLCP(sendToAnalytics);
            window.webVitals.getTTFB(sendToAnalytics);
          }
        };
        document.head.appendChild(script);
      })();
    </script>

    <ClientRouter />

    <script is:inline src="/toggle-theme.js"></script>
  </head>
  <body class="pt-[8vh] md:pt-[12vh]">
    <!-- Google Tag Manager (noscript) -->
    <noscript
      ><iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-KP5D5J3"
        height="0"
        width="0"
        style="display:none;visibility:hidden"></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->

    <slot />

    <!-- Cookie -->
    <script
      is:inline
      defer
      src="https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@v2.8.6/dist/cookieconsent.js"
    ></script>
    <script
      is:inline
      defer
      src="https://cdn.jsdelivr.net/gh/pickyzz/blog-rebuild@main/public/cookies.js"
    ></script>

    <!-- Code copy button script -->
    <script is:inline type="module" src="/scripts/code-copy.js"></script>
    <!-- Global Scroll Reveal Script -->
    <script is:inline>
      document.addEventListener("astro:page-load", () => {
        const observerOptions = {
          root: null,
          rootMargin: "0px",
          threshold: 0,
        };

        const observer = new IntersectionObserver((entries, observer) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add("reveal-visible");
              observer.unobserve(entry.target); // Only animate once
            }
          });
        }, observerOptions);

        const revealElements = document.querySelectorAll(".reveal");
        revealElements.forEach((el) => observer.observe(el));

        // Prevent duplicate navigation
        document.querySelectorAll("a").forEach((link) => {
          link.addEventListener("click", (e) => {
            const href = link.getAttribute("href");
            if (!href) return;

            const url = new URL(href, window.location.origin);
            
            // Check if it's the same page
            if (
              url.origin === window.location.origin &&
              url.pathname === window.location.pathname &&
              !url.hash // Allow hash links to work normally (scrolling)
            ) {
              e.preventDefault();
              // Optional: You could add a smooth scroll to top here if desired
              // window.scrollTo({ top: 0, behavior: 'smooth' });
            }
          });
        });
      });
    </script>
  </body>
</html>

<style>
  html,
  body {
    margin: 0;
    width: 100%;
    height: 100%;
  }
</style>
