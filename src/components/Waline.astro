---
const walineServerURL = import.meta.env.PUBLIC_WALINE_SERVER_URL;
---

<section>
  <div id="waline" class="mx-auto mt-14 max-w-[40rem]" data-server-url={walineServerURL}>
    <script is:inline type="module">
      let walineInstance = null;

      function initializeWaline() {
        const walineEL = document.getElementById("waline");
        if (!walineEL) {
          return;
        }
        if (walineInstance) {
          walineEL;
        }

        const serverURL = walineEL.dataset.serverUrl;

        import("https://unpkg.com/@waline/client@v3/dist/waline.js")
          .then(({ init }) => {
            walineInstance = init({
              el: "#waline",
              serverURL: serverURL,
              path: window.location.pathname.replace(/\/$/, ""),
              lang: "en-us",
              reaction: true,
              commentSorting: "hottest",
              meta: ["nick", "mail"],
              imageUploader: false,
              requiredMeta: ["nick", "mail"],
              noCopyright: true,
              emoji: ["https://unpkg.com/@waline/emojis@1.1.0/alus"],
              dark: 'html[data-theme="dark"]',
            });
          })
          .catch(err => console.error(err));
      }
      if (document.startViewTransition) {
        document.addEventListener("astro:page-load", () => {
          // Lazy load Waline on scroll
          const observer = new IntersectionObserver((entries) => {
             entries.forEach(entry => {
               if (entry.isIntersecting) {
                 initializeWaline();
                 observer.disconnect(); // Load once
               }
             });
          }, { rootMargin: '200px' }); // Load when 200px away
          
          const walineEl = document.getElementById("waline");
          if (walineEl) observer.observe(walineEl);
        });
      } else {
        // Fallback for non-view-transition pages
         document.addEventListener("DOMContentLoaded", () => {
            const observer = new IntersectionObserver((entries) => {
             entries.forEach(entry => {
               if (entry.isIntersecting) {
                 initializeWaline();
                 observer.disconnect();
               }
             });
          }, { rootMargin: '200px' });
          const walineEl = document.getElementById("waline");
          if (walineEl) observer.observe(walineEl);
         });
      }
    </script>
  </div>
</section>
