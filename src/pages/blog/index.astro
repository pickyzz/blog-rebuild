---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Main from "@/layouts/Main.astro";
import Card from "@/components/Card.astro";
import Pagination from "@/components/Pagination.astro";

/* ISR mode with 5-minute revalidation */
export const prerender = true;
export const isr = {
  revalidate: 300, // 5 minutes
  ttl: 300,
  background: true,
};

const { SITE } = await import("@/config");
const getSortedPosts = (await import("@/utils/getSortedPosts")).default;
const { getNotionPosts } = await import("@/utils/getNotionPosts");
const posts = await getNotionPosts();
const publishedPosts = posts.filter(post => !post.data.draft);
const sortedPosts = getSortedPosts(publishedPosts);

const pageSize = SITE.postPerPage || 10;
const page = {
  posts: sortedPosts.slice(0, pageSize),
  currentPage: 1,
  totalPages: Math.max(1, Math.ceil(sortedPosts.length / pageSize)),
  start: 1,
  end: Math.min(pageSize, sortedPosts.length),
  total: sortedPosts.length,
  size: pageSize,
  url: "/blog",
  prev: undefined,
  next: sortedPosts.length > pageSize ? "/blog/page/2" : undefined,
};

console.log(`[BLOG INDEX ISR] Fetched ${posts.length} posts from Notion/Cached`);
console.log(`[BLOG INDEX ISR] Displaying ${page.posts.length} posts`);

/* Set enhanced cache-control header for ISR response */
if (Astro.response && Astro.response.headers) {
  Astro.response.headers.set(
    "cache-control",
    "public, max-age=300, stale-while-revalidate=600, must-revalidate"
  );
  // Add CDN cache headers for better performance
  Astro.response.headers.set(
    "CDN-Cache-Control",
    "public, max-age=300, stale-while-revalidate=600"
  );
  // Add Vercel-specific headers
  Astro.response.headers.set(
    "Vercel-CDN-Cache-Control",
    "public, max-age=300, stale-while-revalidate=600"
  );
}

// Add ISR metadata for debugging
Astro.locals = {
  ...Astro.locals,
  isr: {
    timestamp: new Date().toISOString(),
    revalidateTime: 300,
    source: 'notion-cache'
  }
};
---

<Layout title="Posts" canonicalURL="/blog">
  <Header />
  <Main pageTitle="Posts" pageDesc="All the articles I've posted.">
    {
      page.posts && page.posts.length > 0 ? (
        <ul class="mx-auto grid max-w-[80vw] grid-cols-1 gap-8 md:max-w-4xl md:grid-cols-2">
          {page.posts.map(({ data, id }) => (
            <Card href={`/blog/${data.slug}`} frontmatter={data} />
          ))}
        </ul>
      ) : (
        <p class="text-center">No posts available.</p>
      )
    }
  </Main>

  <Pagination {page} />

  <Footer noMarginTop={page.totalPages > 1} />
</Layout>
