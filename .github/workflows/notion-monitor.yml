name: Check Notion Update with Upstash Redis

on:
  schedule:
    - cron: "0 * * * *" # ทำงานทุกชั่วโมง
  workflow_dispatch:

jobs:
  check-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Fetch and Compare Update Time
        id: deploy_trigger
        run: |
          REDIS_URL="${{ secrets.UPSTASH_REDIS_REST_URL }}"
          REDIS_TOKEN="${{ secrets.UPSTASH_REDIS_REST_TOKEN }}"
          NOTION_PAGE_ID="${{ secrets.DATABASE_ID}}"
          KEY_NAME="notion:last_checked_time"

          NOTION_LAST_UPDATE=$(curl -s -X GET "https://api.notion.com/v1/pages/$NOTION_PAGE_ID" \
            -H "Authorization: Bearer ${{ secrets.NOTION_KEY }}" \
            -H "Notion-Version: 2022-06-28" | jq -r '.last_edited_time')

          REDIS_LAST_UPDATE=$(curl -s -X POST "$REDIS_URL" \
            -H "Authorization: Bearer $REDIS_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"command": ["GET", "'"$KEY_NAME"'"]}' | jq -r '.result')

          echo "Notion Last Update: $NOTION_LAST_UPDATE"
          echo "Redis Last Update: $REDIS_LAST_UPDATE"

          if [ "$NOTION_LAST_UPDATE" != "$REDIS_LAST_UPDATE" ]; then
            echo "::notice title=Deployment Triggered::Notion content updated! Triggering Vercel deployment and updating Redis."

            echo "UPDATED=true" >> $GITHUB_ENV

            echo "NEW_UPDATE_TIME=$NOTION_LAST_UPDATE" >> $GITHUB_ENV
          else
            echo "::notice::No changes detected in Notion content. Skipping deployment."
          fi

      - name: Trigger Vercel Deploy Hook
        if: env.UPDATED == 'true'
        run: |
          echo "Triggering Vercel deployment..."
          curl -X POST ${{ secrets.VERCEL_DEPLOYMENT_HOOK }}

      - name: Update Upstash Redis
        if: env.UPDATED == 'true'
        run: |
          curl -s -X POST ${{ secrets.UPSTASH_REDIS_REST_URL }} \
            -H "Authorization: Bearer ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"command": ["SET", "notion:last-update-time", "'"${{ env.NEW_UPDATE_TIME }}"'"]}'

          echo "Upstash Redis updated to ${{ env.NEW_UPDATE_TIME }}"
