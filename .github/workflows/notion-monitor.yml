name: Check Notion Update with Upstash Redis

on:
  schedule:
    - cron: "0 * * * *" # ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
  workflow_dispatch:

jobs:
  check-and-deploy:
    runs-on: ubuntu-latest

    # 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Environment Variables ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö Job ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Node.js Script ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ
    env:
      UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
      UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
      NOTION_KEY: ${{ secrets.NOTION_KEY }}
      DATABASE_ID: ${{ secrets.DATABASE_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # 2. ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Dependencies ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
      - name: Install dependencies üì¶
        run: npm install

      - name: Fetch and Compare Update Time üîç
        id: deploy_trigger
        # 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Node.js Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Logic ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        run: bun run scripts/checkNotionUpdates.cjs
        # **Script ‡∏à‡∏∞ set output 'should_deploy' ‡πÅ‡∏•‡∏∞ update Redis ‡πÄ‡∏≠‡∏á**

      - name: Trigger Vercel Deploy Hook üöÄ
        # 4. ‡πÉ‡∏ä‡πâ Output ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏¢ Node.js Script
        if: steps.deploy_trigger.outputs.should_deploy == 'true'
        run: |
          echo "Triggering Vercel deployment..."
          curl -X POST ${{ secrets.VERCEL_DEPLOY_HOOK }}
