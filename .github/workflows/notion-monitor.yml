name: Check Notion Update with Upstash Redis

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  check-and-deploy:
    runs-on: ubuntu-latest

    # 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Environment Variables ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö Job ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Node.js Script ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ
    env:
      UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
      UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
      NOTION_KEY: ${{ secrets.NOTION_KEY }}
      DATABASE_ID: ${{ secrets.DATABASE_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # 2. ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Dependencies ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
      - name: Install dependencies üì¶
        run: bun install

      - name: Fetch and Compare Update Time üîç
        id: deploy_trigger
        # 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Node.js Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Logic ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        run: bun run scripts/checkNotionUpdates.cjs
        # **Script ‡∏à‡∏∞ set output 'should_deploy' ‡πÅ‡∏•‡∏∞ update Redis ‡πÄ‡∏≠‡∏á**

      - name: Trigger Vercel Deploy Hook üöÄ
        # 4. ‡πÉ‡∏ä‡πâ Output ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏¢ Node.js Script
        if: steps.deploy_trigger.outputs.should_deploy == 'true'
        run: |
          echo "Triggering Vercel deployment..."
          curl -X POST ${{ secrets.VERCEL_DEPLOY_HOOK }}

      - name: Deployment Summary üìù
        run: |
          SHOULD_DEPLOY="${{ steps.deploy_trigger.outputs.should_deploy }}"
          CURRENT_TIME=$(date "+%Y-%m-%d %H:%M:%S %Z")

          SUMMARY_FILE=$GITHUB_STEP_SUMMARY

          echo "### üìÑ Notion Update & Vercel Deploy Summary" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          if [ "$SHOULD_DEPLOY" = "true" ]; then

            echo "**Status:** ‚úÖ **REDEPLOY Triggered**" >> $SUMMARY_FILE
            echo "- **Reason:** Found Notion content update" >> $SUMMARY_FILE

            if [ -n "${{ env.NEW_UPDATE_TIME }}" ]; then
              echo "- **Notion Update Time:** \`${{ env.NEW_UPDATE_TIME }}\`" >> $SUMMARY_FILE
            fi

            echo "- **Time:** \`${CURRENT_TIME}\`" >> $SUMMARY_FILE
            echo "‚úÖ Vercel Deploy Hook was successfully triggered at $CURRENT_TIME"
          else
            echo "**Status:** ‚è∏Ô∏è **Deploy Skipped**" >> $SUMMARY_FILE
            echo "- **Reason:** Not found Notion update since last time" >> $SUMMARY_FILE
            echo "- **Time:** \`${CURRENT_TIME}\`" >> $SUMMARY_FILE
            echo "‚è∏Ô∏è Skipping Vercel deploy. No Notion updates detected."
          fi
