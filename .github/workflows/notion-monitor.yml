name: Monitor Notion Posts and Trigger Rebuild

on:
  schedule:
    # Run every 15 minutes to check for Notion updates
    - cron: "*/15 * * * *"
  workflow_dispatch: # Allow manual triggering

jobs:
  monitor-notion:
    runs-on: ubuntu-latest
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô (write) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ git push ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏ü‡∏•‡πå timestamp ‡πÑ‡∏î‡πâ
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          cache: "npm"

      - name: Install dependencies for scripts
        run: npm install

      - name: Check for Notion updates and determine deploy status
        id: check-notion
        # ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏à‡∏∞‡πÉ‡∏ä‡πâ ENV variables ‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Output 'should_deploy'
        env:
          NOTION_KEY: ${{ secrets.NOTION_KEY }}
          DATABASE_ID: ${{ secrets.DATABASE_ID }}
        run: |
          node scripts/checkNotionUpdates.cjs
          echo "‚úÖ Notion update check completed"

      - name: Trigger Vercel Deploy Hook
        # ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ Output 'should_deploy' ‡πÄ‡∏õ‡πá‡∏ô 'true'
        if: steps.check-notion.outputs.should_deploy == 'true'
        env:
          VERCEL_DEPLOYMENT_HOOK: ${{ secrets.VERCEL_DEPLOYMENT_HOOK }}
        run: |
          echo "üöÄ Triggering Vercel rebuild..."
          node scripts/triggerVercelDeploy.cjs
